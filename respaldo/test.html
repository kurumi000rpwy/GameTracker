<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crear perfil ‚Äî Form</title>
<style>
  :root{
    --bg:#0F1624;
    --card:#0f2a44;
    --accent:#3b82f6;
    --muted:rgba(255,255,255,0.75);
    --error:#ff6b6b;
    --glass: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family: Inter, system-ui, Arial, sans-serif;
    background:
      linear-gradient(180deg, rgba(10,20,30,0.6) 0%, rgba(10,20,30,0.85) 100%),
      url('https://picsum.photos/seed/bg/1600/900') center/cover no-repeat;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    color:#fff;
  }

  /* Card centrada */
  .card{
    width:100%;
    max-width:520px;
    border-radius:18px;
    padding:28px;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.04);
  }

  .small-label{
    font-size:12px;
    color: rgba(255,255,255,0.35);
    letter-spacing: 1.5px;
    margin-bottom: 14px;
  }

  h1{
    margin:0 0 8px 0;
    font-size:28px;
    line-height:1;
  }

  p.lead{
    margin:0 0 22px 0;
    color:rgba(255,255,255,0.65);
    font-size:14px;
  }

  form .row{
    margin-bottom:16px;
  }

  label{
    display:block;
    font-size:13px;
    margin-bottom:6px;
    color:rgba(255,255,255,0.85);
  }

  input[type="text"],
  input[type="email"],
  input[type="password"]{
    width:100%;
    padding:12px 14px;
    background:var(--glass);
    border:1px solid rgba(255,255,255,0.06);
    border-radius:10px;
    color: #fff;
    font-size:14px;
    outline: none;
    transition: box-shadow .15s, border-color .15s;
  }

  input:focus{
    box-shadow:0 6px 18px rgba(59,130,246,0.12);
    border-color: rgba(59,130,246,0.9);
  }

  .field-inline{
    display:flex;
    gap:8px;
    align-items:center;
  }

  .btn-row{
    display:flex;
    gap:10px;
    margin-top:12px;
  }

  button[type="submit"]{
    margin-left:auto;
    background:var(--accent);
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:999px;
    cursor:pointer;
    font-weight:600;
  }

  button[type="button"]{
    background: rgba(255,255,255,0.06);
    color: #fff;
    border: none;
    padding:10px 14px;
    border-radius:999px;
    cursor:pointer;
  }

  .muted{
    color: rgba(255,255,255,0.6);
    font-size:13px;
  }

  .help{
    font-size:12px;
    color: rgba(255,255,255,0.45);
    margin-top:6px;
  }

  .error{
    color: var(--error);
    font-size:13px;
    margin-top:6px;
  }

  /* ojo (show/hide) */
  .eye-btn{
    background:transparent;
    border:none;
    color:rgba(255,255,255,0.8);
    cursor:pointer;
    padding:6px;
    border-radius:6px;
  }

  .checkbox-row{
    display:flex;
    align-items:center;
    gap:8px;
    margin-top:8px;
    color:rgba(255,255,255,0.8);
  }

  /* Footer peque√±o */
  .footer-note{
    text-align:center;
    margin-top:18px;
    color: rgba(255,255,255,0.45);
    font-size:13px;
  }

  /* Responsive */
  @media (max-width:420px){
    .card{ padding:18px; border-radius:14px; }
    h1{ font-size:22px; }
  }

</style>
</head>
<body>

<main>
  <article class="card" role="region" aria-labelledby="title">
    <div class="small-label">SPECTRA ID</div>
    <h1 id="title">Crea tu perfil</h1>
    <p class="lead">Desbloquea tus rese√±as, progreso sincronizado y recomendaciones personalizadas.</p>

    <form id="form" novalidate>
      <!-- Usuario -->
      <div class="row">
        <label for="username">Nombre de usuario</label>
        <input id="username" name="username" type="text" placeholder="Elige un alias" aria-describedby="userHelp" autocomplete="username">
        <div id="userHelp" class="help">6‚Äì19 caracteres. Letras, n√∫meros, guiones <code>-</code> y puntos <code>.</code> solamente.</div>
        <div id="userError" class="error" role="alert" aria-live="polite"></div>
      </div>

      <!-- Email -->
      <div class="row">
        <label for="email">Correo electr√≥nico</label>
        <input id="email" name="email" type="email" placeholder="nombre@ejemplo.com" autocomplete="email">
        <div id="emailError" class="error" role="alert" aria-live="polite"></div>
      </div>

      <!-- Contrase√±a -->
      <div class="row">
        <label for="password">Contrase√±a</label>
        <div class="field-inline">
          <input id="password" name="password" type="password" placeholder="M√≠nimo 8 caracteres" aria-describedby="passHelp" autocomplete="new-password">
          <button type="button" class="eye-btn" id="togglePwd" aria-label="Mostrar contrase√±a">üëÅÔ∏è</button>
        </div>
        <div id="passHelp" class="help">8‚Äì32 caracteres; al menos una may√∫scula, una min√∫scula, un n√∫mero y un s√≠mbolo.</div>
        <div id="passError" class="error" role="alert" aria-live="polite"></div>
      </div>

      <!-- Confirmar contrase√±a -->
      <div class="row">
        <label for="confirm">Confirmar contrase√±a</label>
        <div class="field-inline">
          <input id="confirm" name="confirm" type="password" placeholder="Repite la contrase√±a" autocomplete="new-password">
          <button type="button" class="eye-btn" id="toggleConfirm" aria-label="Mostrar confirmar contrase√±a">üëÅÔ∏è</button>
        </div>
        <div id="confirmError" class="error" role="alert" aria-live="polite"></div>
      </div>

      <div class="checkbox-row">
        <input id="remember" type="checkbox">
        <label for="remember" class="muted">Recordarme en este equipo</label>
      </div>

      <div class="btn-row">
        <button type="button" id="clearBtn">Limpiar</button>
        <button type="submit">Guardar perfil</button>
      </div>

      <div id="submitResult" class="help" style="margin-top:12px;"></div>
    </form>

    <div class="footer-note">¬øYa tienes cuenta? <a href="#" style="color:var(--accent); text-decoration:none">Iniciar sesi√≥n</a></div>
  </article>
</main>

<script>
/* -------------------------
   Reglas / Regex
   ------------------------- */
const usernameRegex = /^[A-Za-z0-9\-.]{6,19}$/; // permite letras, n√∫meros, puntos y guiones, longitud 6-19
const passwordRegex = /^(?=.{8,32}$)(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).*$/;

/* Elementos */
const form = document.getElementById('form');
const userEl = document.getElementById('username');
const emailEl = document.getElementById('email');
const passEl = document.getElementById('password');
const confirmEl = document.getElementById('confirm');

const userError = document.getElementById('userError');
const emailError = document.getElementById('emailError');
const passError = document.getElementById('passError');
const confirmError = document.getElementById('confirmError');
const submitResult = document.getElementById('submitResult');

const togglePwd = document.getElementById('togglePwd');
const toggleConfirm = document.getElementById('toggleConfirm');
const clearBtn = document.getElementById('clearBtn');

/* -------------------------
   Funciones de sanitizaci√≥n (cliente)
   - Detecta/evita caracteres t√≠picos que usan en NoSQL injection
   - Escapa HTML antes de mostrar cualquier valor en el DOM
   Nota: esto es un filtro en cliente. Repite todas estas validaciones en servidor.
   ------------------------- */

function escapeHtml(str){
  // Escapa para prevenir XSS cuando mostramos texto en la UI
  return String(str).replace(/[&<>"'`=\/]/g, function(s){
    return ({
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;', '/':'&#x2F;', '`':'&#x60;', '=':'&#x3D;'
    })[s];
  });
}

function containsForbiddenNoSQLChars(str){
  // Rechazamos la presencia del signo $ (muy usado en inyecciones NoSQL)
  // o caracteres nulos que puedan romper parsing
  if(!str) return false;
  return /[\0\$]/.test(str);
}

function sanitizeForSubmission(obj){
  // Devuelve copia sanitizada (cliente). El servidor debe validar de nuevo.
  const out = {};
  for(const k in obj){
    let v = obj[k];
    if(typeof v === 'string'){
      // eliminar caracteres NUL
      v = v.replace(/\0/g, '');
      // quitar cualquier $ por seguridad cliente (si tu app necesita $, ajustar)
      v = v.replace(/\$/g, '');
      // trim
      v = v.trim();
    }
    out[k] = v;
  }
  return out;
}

/* -------------------------
   Validadores
   ------------------------- */

function validateUsername(){
  const val = userEl.value.trim();
  userError.textContent = '';
  if(val.length === 0){
    userError.textContent = 'Ingresa un nombre de usuario.';
    return false;
  }
  if(containsForbiddenNoSQLChars(val)){
    userError.textContent = 'Nombre contiene caracteres no permitidos.';
    return false;
  }
  if(!usernameRegex.test(val)){
    userError.textContent = '6‚Äì19 caracteres; solo letras, n√∫meros, puntos y guiones.';
    return false;
  }
  return true;
}

function validateEmail(){
  const val = emailEl.value.trim();
  emailError.textContent = '';
  if(val.length === 0){
    emailError.textContent = 'Ingresa un correo electr√≥nico.';
    return false;
  }
  // validaci√≥n b√°sica de email (cliente)
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!re.test(val)){
    emailError.textContent = 'Correo no v√°lido.';
    return false;
  }
  if(containsForbiddenNoSQLChars(val)){
    emailError.textContent = 'Correo contiene caracteres no permitidos.';
    return false;
  }
  return true;
}

function validatePassword(){
  const val = passEl.value;
  passError.textContent = '';
  if(!passwordRegex.test(val)){
    passError.textContent = 'La contrase√±a debe tener 8‚Äì32 caracteres, 1 may√∫scula, 1 min√∫scula, 1 n√∫mero y 1 s√≠mbolo.';
    return false;
  }
  if(containsForbiddenNoSQLChars(val)){
    passError.textContent = 'La contrase√±a contiene caracteres no permitidos.';
    return false;
  }
  return true;
}

function validateConfirm(){
  confirmError.textContent = '';
  if(confirmEl.value !== passEl.value){
    confirmError.textContent = 'Las contrase√±as no coinciden.';
    return false;
  }
  return true;
}

/* -------------------------
   Eventos
   ------------------------- */

// toggles para mostrar/ocultar
togglePwd.addEventListener('click', () => {
  const t = passEl.type === 'password' ? 'text' : 'password';
  passEl.type = t;
  togglePwd.textContent = t === 'text' ? 'üôà' : 'üëÅÔ∏è';
});

toggleConfirm.addEventListener('click', () => {
  const t = confirmEl.type === 'password' ? 'text' : 'password';
  confirmEl.type = t;
  toggleConfirm.textContent = t === 'text' ? 'üôà' : 'üëÅÔ∏è';
});

// validaci√≥n en blur para retroalimentaci√≥n inmediata
userEl.addEventListener('blur', validateUsername);
emailEl.addEventListener('blur', validateEmail);
passEl.addEventListener('blur', validatePassword);
confirmEl.addEventListener('blur', validateConfirm);

clearBtn.addEventListener('click', () => {
  form.reset();
  userError.textContent = emailError.textContent = passError.textContent = confirmError.textContent = submitResult.textContent = '';
});

/* Submit */
form.addEventListener('submit', (e) => {
  e.preventDefault();
  // limpiar mensajes
  userError.textContent = emailError.textContent = passError.textContent = confirmError.textContent = submitResult.textContent = '';

  // validar
  const vUser = validateUsername();
  const vEmail = validateEmail();
  const vPass = validatePassword();
  const vConfirm = validateConfirm();

  if(!(vUser && vEmail && vPass && vConfirm)){
    submitResult.textContent = 'Corrige los errores antes de enviar.';
    return;
  }

  // sanitizar (cliente) antes de enviar al servidor
  const payload = sanitizeForSubmission({
    username: userEl.value,
    email: emailEl.value,
    password: passEl.value,
    remember: document.getElementById('remember').checked,
  });

  // mostrar resultado en pantalla de forma segura
  // usamos escapeHtml para evitar XSS si mostramos valores
  submitResult.innerHTML = 'Procesando...';

  // Simulaci√≥n de env√≠o (en tu app sustituir por fetch/axios a tu backend seguro)
  setTimeout(() => {
    // aqu√≠ de verdad debes enviar `payload` con HTTPS al servidor, y ALL√ç validar/sanitizar/hashear la contrase√±a
    // mostramos solo confirmaci√≥n; NUNCA loguees contrase√±as reales en producci√≥n
    submitResult.innerHTML = 'Perfil validado localmente. Enviar al servidor para crear la cuenta.';
    console.log('PAYLOAD A ENVIAR (SANITIZADO - cliente):', payload);
  }, 700);
});

/* -------------------------
   NOTAS IMPORTANTES DE SEGURIDAD (leer)
   -------------------------
- Estas medidas en cliente son √∫tiles para UX pero NO son suficientes.
- En el servidor debes:
  1) Validar exactamente las mismas reglas (regex) en backend.
  2) Rechazar cualquier payload que contenga keys o valores con '$' o con caracteres nulos.
  3) Usar consultas parametrizadas o drivers oficiales correctamente:
     - Si usas MongoDB: nunca inyectes objetos recibidos sin validar; evita pasar objetos directos en queries.
  4) Sanitizar/escapar antes de insertar en HTML si vuelves a mostrar valores (escapeHtml).
  5) Hashear contrase√±as con un algoritmo fuerte (bcrypt/argon2) y nunca guardar raw password.
  6) Usar HTTPS y cabeceras de seguridad (Content-Security-Policy, X-Content-Type-Options, etc).
- Para XSS: escapar/filtrar en servidor cualquier dato que luego se renderice en HTML.
- Para NoSQL injection: aseg√∫rate de no permitir operadores ($ne, $gt, etc.) en valores; valida tipos y longitudes.
------------------------- */

</script>
</body>
</html>
